#!/bin/bash

# Initialisation des variables
run_all=false
skip_build=false
run_build=false
run_format=false
run_clean=false
skip_push=false

# Fonction pour afficher l'aide
show_help() {
    echo "Usage: ./deploy [OPTIONS]"
    echo ""
    echo "Options disponibles :"
    echo "  -a    Ex√©cuter toutes les √©tapes automatiquement (build, format, clean, git add, commit, push)"
    echo "  -b    Ex√©cuter uniquement le build (npm run build)"
    echo "  -f    Ex√©cuter uniquement le formatage (npm run format)"
    echo "  -c    Ex√©cuter uniquement le nettoyage (npm run clean:dist:app)"
    echo "  -n    Ne pas ex√©cuter le build"
    echo "  -s    Ne pas ex√©cuter le push (git push)"
    echo "  -h    Afficher ce message d'aide"
    exit 0
}

# Fonction pour demander une confirmation avant d'ex√©cuter une √©tape
confirm() {
    read -p "$1 [y/n] : " response
    case "$response" in
    [yY][eE][sS] | [yY]) return 0 ;;
    *) return 1 ;;
    esac
}

# Lecture des options pass√©es au script
while getopts "abfcnsph" opt; do
    case "$opt" in
    a) run_all=true ;;    # Ex√©cuter toutes les √©tapes automatiquement
    b) run_build=true ;;  # Ex√©cuter uniquement le build
    f) run_format=true ;; # Ex√©cuter uniquement le formatage
    c) run_clean=true ;;  # Ex√©cuter uniquement le clean
    n) skip_build=true ;; # Ne pas ex√©cuter le build
    s) skip_push=true ;;  # Ne pas ex√©cuter le push
    h) show_help ;;       # Afficher l'aide
    *) echo "Option invalide. Utilisez -h pour voir l'aide." && exit 1 ;;
    esac
done

# √âtape 1 : Build
if $run_all || $run_build; then
    echo "üì¶ Ex√©cution de 'npm run build'..."
    npm run build
elif ! $skip_build; then
    confirm "Voulez-vous ex√©cuter 'npm run build' ?" && npm run build
fi

# √âtape 2 : Format
if $run_all || $run_format; then
    echo "üñãÔ∏è Ex√©cution de 'npm run format'..."
    npm run format
else
    confirm "Voulez-vous ex√©cuter 'npm run format' ?" && npm run format
fi

# √âtape 3 : Clean
if $run_all || $run_clean; then
    echo "üßπ Ex√©cution de 'npm run clean:dist:app'..."
    npm run clean:dist:app
else
    confirm "Voulez-vous ex√©cuter 'npm run clean:dist:app' ?" && npm run clean:dist:app
fi

# √âtape 4 : Git add
if $run_all; then
    echo "‚ûï Ajout des changements √† Git..."
    git add .
else
    confirm "Voulez-vous ex√©cuter 'git add .' ?" && git add .
fi

# √âtape 5 : Git commit
if $run_all; then
    read -p "Entrez le message de commit : " commit_message
    git commit -m "$commit_message"
else
    confirm "Voulez-vous ex√©cuter 'git commit' ?" && {
        read -p "Entrez le message de commit : " commit_message
        git commit -m "$commit_message"
    }
fi

# √âtape 6 : Git push
if $run_all && ! $skip_push; then
    echo "‚¨ÜÔ∏è Pouss√©e des changements sur 'main'..."
    git push -u origin main
elif ! $skip_push; then
    confirm "Voulez-vous ex√©cuter 'git push' ?" && git push -u origin main
fi

echo "‚úÖ Script termin√© !"
