name: Deploy to VPS

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          # Si l'IP a changé récemment, on purge l'ancienne empreinte (évite l'erreur host key changed)
          ssh-keygen -R "${{ secrets.VPS_IP }}" || true
          # Ajoute l'empreinte courante
          ssh-keyscan -p "${{ secrets.SSH_PORT || 22 }}" -H "${{ secrets.VPS_IP }}" >> ~/.ssh/known_hosts

      - name: Deploy to VPS
        env:
          SSH_USER: ${{ secrets.VPS_USER }}
          SSH_HOST: ${{ secrets.VPS_IP }}
          SSH_PORT: ${{ secrets.SSH_PORT || 22 }}
        run: |
          ssh -o StrictHostKeyChecking=yes -i ~/.ssh/id_rsa -p "$SSH_PORT" "$SSH_USER@$SSH_HOST" 'bash -s' << 'EOF'
            set -e
            cd /var/www/konect-saas

            # Récupérer les dernières modifs
            git pull origin main

            # Installer dépendances PHP
            composer install --no-dev --optimize-autoloader

            # Installer dépendances JS et builder
            npm ci || npm install
            npm run build

            # Laravel ops
            php artisan migrate --force
            php artisan config:clear
            php artisan config:cache
            php artisan route:cache || true
            php artisan view:cache || true

            # Redémarrer les workers (silencieux si absent)
            php artisan queue:restart || true
          EOF
